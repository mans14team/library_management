files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/02_docker_login.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e

      echo "Starting Docker authentication setup..."

      # 환경 변수 검증
      if [ -z "$DOCKER_USERNAME" ] || [ -z "$DOCKER_PASSWORD" ]; then
        echo "ERROR: Docker credentials are not properly set"
        echo "DOCKER_USERNAME: ${DOCKER_USERNAME:-not set}"
        echo "DOCKER_PASSWORD: ${DOCKER_PASSWORD:-not set}"
        exit 1
      fi

      # Docker 설정 디렉토리 생성
      echo "Creating Docker config directory..."
      mkdir -p /home/ec2-user/.docker

      # Docker 인증 파일 생성
      echo "Generating Docker auth configuration..."
      AUTH_TOKEN=$(echo -n "${DOCKER_USERNAME}:${DOCKER_PASSWORD}" | base64)
      cat > /home/ec2-user/.docker/config.json << EOF
      {
        "auths": {
          "https://index.docker.io/v1/": {
            "auth": "${AUTH_TOKEN}"
          }
        }
      }
      EOF

      # 권한 설정
      chmod 600 /home/ec2-user/.docker/config.json
      chown -R ec2-user:ec2-user /home/ec2-user/.docker

      echo "Docker authentication setup completed successfully"

container_commands:
  01_verify_env_and_image:
    command: |
      #!/bin/bash
      set -e
      echo "Verifying environment settings and Docker image..."

      # 필수 환경 변수 목록
      required_vars=(
        "DOCKER_USERNAME"
        "DOCKER_PASSWORD"
        "IMAGE_TAG"
        "REDIS_PASSWORD"
        "REDIS_HOST"
        "DB_HOST"
        "DB_USERNAME"
        "DB_PASSWORD"
        "JWT_SECRET_KEY"
        "SPRING_PROFILES_ACTIVE"
      )

      # 환경 변수 검증
      for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
          echo "ERROR: $var is not set"
          exit 1
        fi
        echo "$var is set"
      done

      # Docker 이미지 확인
      if ! docker images | grep -q "${DOCKER_USERNAME}/spring-app"; then
        echo "ERROR: Required Docker image not found"
        docker images
        exit 1
      fi
      echo "Docker image is available."
