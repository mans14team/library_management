option_settings:
  aws:elasticbeanstalk:application:environment:
    ECR_REGISTRY: "${ECR_REGISTRY}"
    ECR_REPOSITORY: "${ECR_REPOSITORY}"
    REDIS_PASSWORD: "${REDIS_PASSWORD}"
    REDIS_HOST: "${REDIS_HOST}"
    DB_HOST: "${DB_HOST}"
    DB_USERNAME: "${DB_USERNAME}"
    DB_PASSWORD: "${DB_PASSWORD}"
    JWT_SECRET_KEY: "${JWT_SECRET_KEY}"
    OWNER_TOKEN: "${OWNER_TOKEN}"
    TOSS_SECRET_KEY: "${TOSS_SECRET_KEY}"
    TOSS_CLIENT_KEY: "${TOSS_CLIENT_KEY}"
    TOSS_SUCCESS_URL: "${TOSS_SUCCESS_URL}"
    TOSS_FAIL_URL: "${TOSS_FAIL_URL}"
    TOSS_BASE_URL: "${TOSS_BASE_URL}"
    SPRING_PROFILES_ACTIVE: "prod"

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/02_docker_login.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e

      echo "Loading environment variables from .env file..."

      # .env 파일 경로
      ENV_FILE="/var/app/staging/.env"

      # .env 파일이 존재하는지 확인하고 로드
      if [ -f "$ENV_FILE" ]; then
        export $(cat $ENV_FILE | xargs)  # .env 파일 내용을 환경 변수로 설정
        echo "Environment variables loaded from .env file"
      else
        echo "ERROR: .env file not found at $ENV_FILE"
        exit 1
      fi

      echo "Starting ECR authentication setup..."

      # 환경 변수 검증
      if [ -z "$ECR_REGISTRY" ]; then
        echo "ERROR: ECR_REGISTRY is not set"
        exit 1
      fi

      # ECR 로그인
      aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin "${ECR_REGISTRY}"

      echo "ECR authentication setup completed successfully"

container_commands:
  01_verify_env_and_image:
    command: |
      #!/bin/bash
      set -e
      echo "Verifying environment settings and Docker image..."

      # 필수 환경 변수 목록 (ECR 방식으로 수정)
      required_vars=(
        "REDIS_PASSWORD"
        "REDIS_HOST"
        "DB_HOST"
        "DB_USERNAME"
        "DB_PASSWORD"
        "JWT_SECRET_KEY"
        "SPRING_PROFILES_ACTIVE"
      )

      # 환경 변수 검증
      for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
          echo "ERROR: $var is not set"
          exit 1
        fi
        echo "$var is set to ${!var}"
      done

      # ECR 이미지 존재 여부 확인
      if ! aws ecr describe-images --repository-name ${ECR_REPOSITORY} --registry-id ${ECR_REGISTRY%%.*} >/dev/null 2>&1; then
        echo "ERROR: ECR repository or images not found"
        exit 1
      fi
      echo "ECR repository verified successfully"

