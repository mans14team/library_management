files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/02_docker_login.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Docker 로그인
      if ! echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin; then
        echo "Docker login failed"
        exit 1
      fi

container_commands:
  01_prepare_container:
    command: |
      # 기존 컨테이너 정리
      docker ps -aq | xargs -r docker stop
      docker ps -aq | xargs -r docker rm

      # Pull the latest image
      if ! docker pull ${DOCKER_USERNAME}/spring-app:${IMAGE_TAG}; then
        echo "Failed to pull image"
        exit 1
      fi

      # Tag the pulled image
      if ! docker tag ${DOCKER_USERNAME}/spring-app:${IMAGE_TAG} aws_beanstalk/current-app:latest; then
        echo "Failed to tag image"
        exit 1
      fi

      echo "Successfully prepared container"

  02_verify_image:
    command: |
      # 이미지 존재 확인
      if ! docker images | grep -q "aws_beanstalk/current-app"; then
        echo "Current app image not found!"
        exit 1
      fi
      echo "Image verification successful"