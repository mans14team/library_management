files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/02_docker_login.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e

      echo "Starting ECR authentication setup..."

      # 환경 변수 검증
      if [ -z "$ECR_REGISTRY" ]; then
        echo "ERROR: ECR_REGISTRY is not set"
        exit 1
      fi

      # ECR 로그인
      aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin "${ECR_REGISTRY}"

      echo "ECR authentication setup completed successfully"

container_commands:
  01_verify_env_and_image:
    command: |
      #!/bin/bash
      set -e
      echo "Verifying environment settings and Docker image..."

      # 필수 환경 변수 목록 (ECR 방식으로 수정)
      required_vars=(
        "ECR_REGISTRY"
        "ECR_REPOSITORY"
        "REDIS_PASSWORD"
        "REDIS_HOST"
        "DB_HOST"
        "DB_USERNAME"
        "DB_PASSWORD"
        "JWT_SECRET_KEY"
        "SPRING_PROFILES_ACTIVE"
      )

      # 환경 변수 검증
      for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
          echo "ERROR: $var is not set"
          exit 1
        fi
        echo "$var is set"
      done

      # ECR 이미지 존재 여부 확인
      if ! aws ecr describe-images --repository-name ${ECR_REPOSITORY} --registry-id ${ECR_REGISTRY%%.*} >/dev/null 2>&1; then
        echo "ERROR: ECR repository or images not found"
        exit 1
      fi
      echo "ECR repository verified successfully"
