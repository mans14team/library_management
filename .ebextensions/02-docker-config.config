files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/02_docker_login.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Docker 로그인
      echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

container_commands:
  01_prepare_container:
    command: |
      # 기존 컨테이너 정리
      docker ps -aq | xargs -r docker stop
      docker ps -aq | xargs -r docker rm

      # 기존 이미지 정리
      docker images | grep "aws_beanstalk" | awk '{print $3}' | xargs -r docker rmi -f

      # 스테이징 이미지에서 현재 이미지로 태그 변경
      STAGING_IMAGE="aws_beanstalk/staging-app:latest"
      CURRENT_IMAGE="aws_beanstalk/current-app:latest"

      if docker images | grep -q "aws_beanstalk/staging-app"; then
        echo "Tagging staging app as current app"
        docker tag $STAGING_IMAGE $CURRENT_IMAGE
        echo "Tagged $STAGING_IMAGE as $CURRENT_IMAGE"
      fi

  02_verify_image:
    command: |
      # 이미지 존재 확인
      if ! docker images | grep -q "aws_beanstalk/current-app"; then
        echo "Current app image not found!"
        exit 1
      fi